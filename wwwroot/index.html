<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossV9 Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #050505;
            --panel: #0e0e0e;
            --panel-2: #151515;
            --line: #2c2c2c;
            --text: #f5f5f5;
            --muted: #a2a2a2;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: Inter, Segoe UI, Roboto, sans-serif;
            background: radial-gradient(circle at top right, #171717 0%, #050505 48%);
            color: var(--text);
        }
        .wrap { max-width: 1360px; margin: 24px auto; padding: 0 16px; }
        .top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        .title { font-size: 28px; letter-spacing: 1px; }
        .sub { color: var(--muted); font-size: 13px; }
        .chip {
            border: 1px solid var(--line);
            background: #0b0b0b;
            border-radius: 999px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--muted);
        }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab {
            border: 1px solid var(--line);
            background: #0b0b0b;
            color: var(--muted);
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
        }
        .tab.active { color: var(--text); border-color: #ffffff66; background: #161616; }
        .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
        .panel {
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 16px;
        }
        .single-col { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .hidden { display: none; }
        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }
        .btn {
            background: #f5f5f5;
            color: #080808;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn.secondary {
            background: #222;
            color: #eee;
            border: 1px solid #333;
        }
        .btn:disabled { opacity: 0.45; cursor: not-allowed; }
        .drop {
            border: 1px dashed #444;
            border-radius: 10px;
            padding: 22px;
            background: #0a0a0a;
            text-align: center;
            color: var(--muted);
            margin-top: 8px;
            user-select: none;
        }
        .drop.drag { border-color: #fff; color: #fff; }
        input[type="file"] { display: none; }
        .progress {
            height: 10px;
            border-radius: 999px;
            background: #202020;
            margin-top: 10px;
            overflow: hidden;
        }
        .bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #5f5f5f, #fff);
            transition: width .25s ease;
        }
        .stat-grid {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(2, minmax(120px, 1fr));
            gap: 10px;
        }
        .stat {
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 10px;
            background: #0d0d0d;
            animation: pulse .8s ease;
        }
        .stat .k { font-size: 12px; color: var(--muted); }
        .stat .v { font-size: 20px; margin-top: 3px; }
        @keyframes pulse {
            from { transform: scale(.98); opacity: .6; }
            to { transform: scale(1); opacity: 1; }
        }
        .small { color: var(--muted); font-size: 12px; }
        .result {
            margin-top: 12px;
            border: 1px solid #2f2f2f;
            border-radius: 8px;
            padding: 10px;
            background: #0b0b0b;
        }
        .table-wrap {
            max-height: 260px;
            overflow: auto;
            margin-top: 12px;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td {
            border-bottom: 1px solid #252525;
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
        }
        th {
            color: #d0d0d0;
            position: sticky;
            top: 0;
            background: #111;
        }
        .ok { color: #d0ffd0; }
        .err { color: #ffd0d0; }
        @media (max-width: 980px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="top">
        <div>
            <div class="title">CrossV9 Compression Interface</div>
            <div class="sub">Cluster-safe browser upload flow. No server-local file path required.</div>
        </div>
        <div class="chip" id="modeChip">Mode: Browser Upload</div>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="single">Single File</button>
        <button class="tab" data-tab="batch">Folder / Batch</button>
        <button class="tab" data-tab="stats">Statistics</button>
    </div>

    <div id="single" class="tab-pane">
        <div class="grid">
            <div class="panel">
                <h3>Compress Local File</h3>
                <div class="drop" id="singleDrop">Drop file here, or click to select</div>
                <input id="singleInput" type="file">
                <div class="row">
                    <button class="btn" id="compressSingleBtn" disabled>Compress and Download</button>
                    <button class="btn secondary" id="refreshBtn">Refresh Stats</button>
                </div>
                <div class="progress"><div class="bar" id="singleBar"></div></div>
                <div class="small" id="singleStatus">Idle</div>
                <div class="result hidden" id="singleResult"></div>
            </div>

            <div class="panel">
                <h3>Live Stats</h3>
                <div class="stat-grid">
                    <div class="stat"><div class="k">Original</div><div class="v" id="sOriginal">0 B</div></div>
                    <div class="stat"><div class="k">Compressed</div><div class="v" id="sCompressed">0 B</div></div>
                    <div class="stat"><div class="k">Savings</div><div class="v" id="sSavings">0 B</div></div>
                    <div class="stat"><div class="k">References</div><div class="v" id="sRefs">0</div></div>
                </div>
                <div style="margin-top:12px;"><canvas id="singleChart" height="160"></canvas></div>
            </div>
        </div>
    </div>

    <div id="batch" class="tab-pane hidden">
        <div class="single-col">
            <div class="panel">
                <h3>Compress Folder from Browser</h3>
                <div class="small">Select a local folder. Files are uploaded as bytes and compressed server-side. This works on remote clusters.</div>
                <div class="row">
                    <button class="btn secondary" id="pickFolderBtn">Pick Folder</button>
                    <input id="folderInput" type="file" webkitdirectory directory multiple>
                    <button class="btn" id="startBatchBtn" disabled>Start Batch</button>
                </div>
                <div class="small" id="folderSummary">No files selected</div>
                <div class="progress"><div class="bar" id="batchBar"></div></div>
                <div class="small" id="batchStatus">Idle</div>
            </div>
            <div class="grid">
                <div class="panel">
                    <h3>References Per File</h3>
                    <canvas id="refsChart" height="170"></canvas>
                </div>
                <div class="panel">
                    <h3>Compression Ratio Per File</h3>
                    <canvas id="ratioChart" height="170"></canvas>
                </div>
            </div>
            <div class="panel">
                <h3>Batch Results</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                        <tr><th>#</th><th>File</th><th>Original</th><th>Compressed</th><th>Refs</th><th>Status</th></tr>
                        </thead>
                        <tbody id="batchTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="stats" class="tab-pane hidden">
        <div class="panel">
            <h3>Service Statistics</h3>
            <div class="row"><button class="btn" id="loadStatsBtn">Load</button></div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>File</th><th>Original</th><th>Compressed</th><th>Ratio</th><th>Refs</th><th>Time</th></tr></thead>
                    <tbody id="statsTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(btn => btn.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".tab-pane").forEach(p => p.classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
    }));

    const fmtBytes = n => {
        if (!n || n <= 0) return "0 B";
        const u = ["B", "KB", "MB", "GB", "TB"];
        const i = Math.min(Math.floor(Math.log(n) / Math.log(1024)), u.length - 1);
        return `${(n / Math.pow(1024, i)).toFixed(i === 0 ? 0 : 2)} ${u[i]}`;
    };

    function setBar(el, pct) {
        el.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    const singleDrop = document.getElementById("singleDrop");
    const singleInput = document.getElementById("singleInput");
    const compressSingleBtn = document.getElementById("compressSingleBtn");
    const singleBar = document.getElementById("singleBar");
    const singleStatus = document.getElementById("singleStatus");
    const singleResult = document.getElementById("singleResult");
    let selectedSingle = null;

    singleDrop.addEventListener("click", () => singleInput.click());
    singleInput.addEventListener("change", () => {
        selectedSingle = singleInput.files[0] || null;
        singleDrop.textContent = selectedSingle ? `${selectedSingle.name} (${fmtBytes(selectedSingle.size)})` : "Drop file here, or click to select";
        compressSingleBtn.disabled = !selectedSingle;
    });

    ["dragenter", "dragover"].forEach(evt => {
        singleDrop.addEventListener(evt, e => {
            e.preventDefault();
            singleDrop.classList.add("drag");
        });
    });
    ["dragleave", "drop"].forEach(evt => {
        singleDrop.addEventListener(evt, e => {
            e.preventDefault();
            singleDrop.classList.remove("drag");
        });
    });
    singleDrop.addEventListener("drop", e => {
        const f = e.dataTransfer.files[0];
        if (!f) return;
        selectedSingle = f;
        singleDrop.textContent = `${f.name} (${fmtBytes(f.size)})`;
        compressSingleBtn.disabled = false;
    });

    const singleChart = new Chart(document.getElementById("singleChart"), {
        type: "bar",
        data: {
            labels: ["Original", "Compressed"],
            datasets: [{ data: [0, 0], backgroundColor: ["#808080", "#ffffff"] }]
        },
        options: {
            responsive: true,
            animation: { duration: 500 },
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: "#ccc" } },
                y: { ticks: { color: "#ccc" } }
            }
        }
    });

    function renderSingleStats(original, compressed, refs) {
        document.getElementById("sOriginal").textContent = fmtBytes(original);
        document.getElementById("sCompressed").textContent = fmtBytes(compressed);
        document.getElementById("sSavings").textContent = fmtBytes(Math.max(0, original - compressed));
        document.getElementById("sRefs").textContent = String(refs || 0);
        singleChart.data.datasets[0].data = [original, compressed];
        singleChart.update();
    }

    async function compressFileBinary(file, statusLabel) {
        const formData = new FormData();
        formData.append("file", file);

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 1000 * 60 * 20);
        try {
            const res = await fetch("/api/compression/compress-binary", {
                method: "POST",
                body: formData,
                signal: controller.signal
            });
            if (!res.ok) {
                throw new Error(`Compression failed (${res.status})`);
            }

            const blob = await res.blob();
            const original = Number(res.headers.get("X-Cross-Original-Size") || file.size || 0);
            const compressed = Number(res.headers.get("X-Cross-Compressed-Size") || blob.size || 0);
            const refs = Number(res.headers.get("X-Cross-References-Found") || 0);
            const chunks = Number(res.headers.get("X-Cross-Total-Chunks") || 0);
            if (statusLabel) statusLabel.textContent = `Done: ${file.name}`;
            return { blob, original, compressed, refs, chunks };
        } finally {
            clearTimeout(timer);
        }
    }

    compressSingleBtn.addEventListener("click", async () => {
        if (!selectedSingle) return;
        compressSingleBtn.disabled = true;
        setBar(singleBar, 10);
        singleStatus.textContent = "Uploading and compressing...";
        singleResult.classList.add("hidden");

        try {
            const out = await compressFileBinary(selectedSingle, singleStatus);
            setBar(singleBar, 90);

            const a = document.createElement("a");
            a.href = URL.createObjectURL(out.blob);
            a.download = `${selectedSingle.name}.ccf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(a.href);

            renderSingleStats(out.original, out.compressed, out.refs);
            singleResult.innerHTML = `Compression complete.<br>References: ${out.refs} / Chunks: ${out.chunks}`;
            singleResult.classList.remove("hidden");
            setBar(singleBar, 100);
            singleStatus.textContent = "Ready";
        } catch (err) {
            singleStatus.textContent = `Error: ${err.message}`;
        } finally {
            compressSingleBtn.disabled = false;
        }
    });

    document.getElementById("refreshBtn").addEventListener("click", async () => {
        const res = await fetch("/api/compression/statistics/summary");
        if (!res.ok) return;
        const sum = await res.json();
        renderSingleStats(sum.totalOriginalSize || 0, sum.totalCompressedSize || 0, sum.totalReferencesFound || 0);
    });

    const folderInput = document.getElementById("folderInput");
    const pickFolderBtn = document.getElementById("pickFolderBtn");
    const startBatchBtn = document.getElementById("startBatchBtn");
    const folderSummary = document.getElementById("folderSummary");
    const batchStatus = document.getElementById("batchStatus");
    const batchBar = document.getElementById("batchBar");
    const batchTable = document.getElementById("batchTable");
    let batchFiles = [];

    const refsChart = new Chart(document.getElementById("refsChart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "References", data: [], borderColor: "#fff", pointBackgroundColor: "#fff" }] },
        options: {
            responsive: true,
            animation: { duration: 350 },
            plugins: { legend: { labels: { color: "#ddd" } } },
            scales: { x: { ticks: { color: "#bbb" } }, y: { ticks: { color: "#bbb" } } }
        }
    });

    const ratioChart = new Chart(document.getElementById("ratioChart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Ratio", data: [], borderColor: "#9b9b9b", pointBackgroundColor: "#9b9b9b" }] },
        options: {
            responsive: true,
            animation: { duration: 350 },
            plugins: { legend: { labels: { color: "#ddd" } } },
            scales: { x: { ticks: { color: "#bbb" } }, y: { ticks: { color: "#bbb" } } }
        }
    });

    pickFolderBtn.addEventListener("click", () => folderInput.click());
    folderInput.addEventListener("change", () => {
        batchFiles = Array.from(folderInput.files || []);
        const total = batchFiles.reduce((a, f) => a + f.size, 0);
        folderSummary.textContent = `${batchFiles.length} files selected (${fmtBytes(total)})`;
        startBatchBtn.disabled = batchFiles.length === 0;
    });

    startBatchBtn.addEventListener("click", async () => {
        if (batchFiles.length === 0) return;
        startBatchBtn.disabled = true;
        batchTable.innerHTML = "";
        refsChart.data.labels = [];
        refsChart.data.datasets[0].data = [];
        refsChart.update();
        ratioChart.data.labels = [];
        ratioChart.data.datasets[0].data = [];
        ratioChart.update();

        let done = 0;
        for (let i = 0; i < batchFiles.length; i++) {
            const file = batchFiles[i];
            batchStatus.textContent = `Processing ${i + 1}/${batchFiles.length}: ${file.name}`;
            try {
                const out = await compressFileBinary(file);
                const ratio = out.original > 0 ? out.compressed / out.original : 0;

                refsChart.data.labels.push(String(i + 1));
                refsChart.data.datasets[0].data.push(out.refs);
                refsChart.update();

                ratioChart.data.labels.push(String(i + 1));
                ratioChart.data.datasets[0].data.push(Number(ratio.toFixed(3)));
                ratioChart.update();

                batchTable.insertAdjacentHTML(
                    "beforeend",
                    `<tr><td>${i + 1}</td><td>${file.webkitRelativePath || file.name}</td><td>${fmtBytes(out.original)}</td><td>${fmtBytes(out.compressed)}</td><td>${out.refs}</td><td class="ok">OK</td></tr>`
                );
            } catch (err) {
                batchTable.insertAdjacentHTML(
                    "beforeend",
                    `<tr><td>${i + 1}</td><td>${file.webkitRelativePath || file.name}</td><td>${fmtBytes(file.size)}</td><td>-</td><td>-</td><td class="err">ERROR</td></tr>`
                );
            }
            done++;
            setBar(batchBar, (done / batchFiles.length) * 100);
        }

        batchStatus.textContent = `Batch done. ${done}/${batchFiles.length}`;
        startBatchBtn.disabled = false;
    });

    document.getElementById("loadStatsBtn").addEventListener("click", async () => {
        const table = document.getElementById("statsTable");
        table.innerHTML = "";
        const res = await fetch("/api/compression/statistics?limit=200");
        if (!res.ok) return;
        const rows = await res.json();
        if (!rows.length) {
            table.innerHTML = `<tr><td colspan="6">No data</td></tr>`;
            return;
        }
        rows.forEach(r => {
            table.insertAdjacentHTML(
                "beforeend",
                `<tr><td>${r.fileName || "-"}</td><td>${fmtBytes(r.originalSize || 0)}</td><td>${fmtBytes(r.compressedSize || 0)}</td><td>${((r.compressionRatio || 0) * 100).toFixed(2)}%</td><td>${r.referencesFound || 0}</td><td>${(r.durationMs || 0).toFixed(0)}ms</td></tr>`
            );
        });
    });
})();
</script>
</body>
</html>
